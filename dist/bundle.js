(()=>{"use strict";var e={n:s=>{var t=s&&s.__esModule?()=>s.default:()=>s;return e.d(t,{a:t}),t},d:(s,t)=>{for(var n in t)e.o(t,n)&&!e.o(s,n)&&Object.defineProperty(s,n,{enumerable:!0,get:t[n]})},o:(e,s)=>Object.prototype.hasOwnProperty.call(e,s)};const s=require("express");var t=e.n(s);const n=require("mongoose");var a=e.n(n);const r=require("dotenv");var o=e.n(r);o().config();const i=process.env.PORT||8e3,d=a().Schema({name:{type:String,required:!0},email:{type:String,required:!0,unique:!0},password:{type:String,required:!0},user_role:{type:String,required:!0},isActive:{type:Boolean,default:!1},resetPasswordToken:{type:String},resetPasswordExpires:{type:Date}},{timestamps:!1,versionKey:!1}),u=a().model("user",d),c=a().Schema({user_id:{type:String,required:!0},bdm:{type:String,required:!0},branch_name:{type:String,required:!0},company_name:{type:String},contact_person:{type:String,required:!0},email:{type:String,required:!0},contact_no:{type:Number,required:!0},services:{type:[String],required:!0},closed_by:{type:String},total_amount:{type:Number,required:!0},term_1:{type:Number},term_2:{type:Number},term_3:{type:Number},term_1_payment_date:{type:String},term_2_payment_date:{type:String},term_3_payment_date:{type:String},pan:{type:String},gst:{type:String},remark:{type:String},date:{type:Date,required:!0},after_disbursement:{type:String},bank:{type:String},state:{type:String,required:!0},status:{type:String},status:{type:String},state:{type:String,required:!0},updatedhistory:[{updatedBy:String,updatedAt:{type:Date,default:Date.now},note:String,changes:{type:Map,of:new(a().Schema)({old:a().Schema.Types.Mixed,new:a().Schema.Types.Mixed},{_id:!1})}}]},{versionKey:!1,timestamps:!0}),m=a().model("booking",c),g=require("crypto");var l=e.n(g);const p=require("nodemailer");var y=e.n(p);const f=require("bcrypt");var h=e.n(f);const w=require("jsonwebtoken");var v=e.n(w);const b=async(e,s,t)=>{try{const n=e.headers.authorization;if(!n)return s.status(401).send({message:"Authentication required"});const a=v().verify(n,process.env.JWT_SECRET);e.user=a,t()}catch(e){return s.status(401).send({message:"Invalid or expired token"})}},_=(e,s,t)=>{if("dev"!==e.user?.user_role)return s.status(403).send({message:"Access denied. Only devs can access this route."});t()};o().config();const S=t().Router();S.post("/adduser",b,_,(async(e,s)=>{try{const{name:t,email:n,password:a,user_role:r}=e.body;if(!t||!n||!a)return s.status(400).send({message:"send all required fields: name, email, password"});const o=n.toLowerCase();if(await u.findOne({email:o}))return s.status(409).send({message:"Email is already registered"});const i={name:t,email:o,password:await h().hash(a,5),user_role:r},d=await u.create(i);return s.status(201).send(d)}catch(e){return console.log(e.message),s.status(500).send({message:e.message})}})),S.patch("/edituser/:id",b,_,(async(e,s)=>{try{const{id:t}=e.params,n=e.body;if(!n||0===Object.keys(n).length)return s.status(400).send({message:"No fields provided for update"});if(n.email&&(n.email=n.email.toLowerCase(),await u.findOne({email:n.email,_id:{$ne:t}})))return s.status(409).send({message:"Email is already registered"});n.password&&(n.password=await h().hash(n.password,5));const a=await u.findByIdAndUpdate(t,{$set:n},{new:!0,runValidators:!0});return a?s.status(200).send({message:"User updated successfully",user:a}):s.status(404).send({message:"User not found"})}catch(e){return console.error(e.message),s.status(500).send({message:e.message})}})),S.delete("/deleteuser/:id",b,_,(async(e,s)=>{try{const{id:t}=e.params;return await u.findById(t)?(await u.findByIdAndDelete(t),s.status(200).send({message:"User deleted successfully"})):s.status(404).send({message:"User not found"})}catch(e){return console.log(e.message),s.status(500).send({message:e.message})}})),S.get("/all",b,(async(e,s)=>{try{const e=await u.find({}).select("-password");if(0===e.length)return s.status(404).send({message:"No Users found"});e.length,s.status(200).send({Users:e})}catch(e){return console.log(e.message),s.status(500).send({message:e.message})}})),S.post("/login",(async(e,s)=>{try{const{email:t,password:n}=e.body;if(!t||!n)return s.status(400).send({message:"Please provide both email and password."});const a=await u.findOneAndUpdate({email:t},{isActive:!0});if(!a)return s.status(404).send({message:"User not found."});if(!await h().compare(n,a.password))return s.status(401).send({message:"Invalid email or password."});const r=(e=>v().sign({userId:e._id,user_role:e.user_role},process.env.JWT_SECRET,{expiresIn:"24h"}))(a);s.status(200).send({token:r,user:a})}catch(e){return console.log(e.message),s.status(500).send({message:e.message})}})),S.patch("/logout/:id",(async(e,s)=>{const{id:t}=e.params;try{const e=await u.findByIdAndUpdate(t,{isActive:!1});if(!e)return s.status(404).send({message:"User not found."});s.send(e)}catch(e){return s.status(500).send({message:e.message})}})),S.get("/bookings/:id",b,(async(e,s)=>{const t=e.params.id;try{if(!e.params.id)return s.status(400).send({message:"Not A VALID USER"});const n=await m.find({user_id:t});if(0===n.length)return s.status(404).send({message:"No bookings found for this user"});s.status(200).send(n)}catch(e){return console.log(e.message),s.status(500).send({message:e.message})}})),S.get("/:id?",b,(async(e,s)=>{const t=e.params.id,n=e.query.pattern,a=e.query.userRole,r=e.query.userId;parseInt(n);try{let e;if(t){if(e=["dev","admin","senior admin"].includes(a)?await m.find({_id:t}):await m.find({_id:t,user_id:r}),0===e.length)return s.status(404).send({message:"No bookings found with this id"})}else{if(!n)return s.status(400).send({message:"Either id or pattern query parameter is required"});{const t={$or:[{company_name:{$regex:n,$options:"i"}},{contact_person:{$regex:n,$options:"i"}},{email:{$regex:n,$options:"i"}},{pan:{$regex:n,$options:"i"}},{gst:{$regex:n,$options:"i"}},{services:{$regex:n,$options:"i"}},{$expr:{$regexMatch:{input:{$toString:"$contact_no"},regex:n}}}]};if(e=["dev","admin","senior admin"].includes(a)?await m.find(t):await m.find({...t,user_id:r}),0===e.length)return s.status(404).send({message:"No bookings found matching the pattern"})}}s.status(200).send(e)}catch(e){return console.log(e.message),s.status(500).send({message:e.message})}})),S.get("/:id",(async(e,s)=>{const t=e.params.id;try{if(!e.params.id)return s.status(400).send({message:"Not A VALID USER"});if(0===(await u.find({_id:t})).length)return s.status(404).send({message:"No User found with this id",status:!1});s.status(200).send({message:"VALID USER",status:!0})}catch(e){return console.log(e.message),s.status(500).send({message:e.message})}})),S.put("/password-reset",(async(e,s)=>{const{password:t,email:n}=e.body;if(!n||!t)return s.status(400).send({message:"Please provide both email and new password"});const a=n.toLowerCase();try{const e=await u.findOne({email:a});if(!e)return s.status(404).send({message:"User not found with this email"});const n=await h().hash(t,5);return e.password=n,await e.save(),s.status(200).send({message:"Password updated successfully"})}catch(e){return console.log(e.message),s.status(500).send({message:e.message})}})),S.post("/request-reset-password",(async(e,s)=>{const{email:t}=e.body;try{const e=await u.findOne({email:t});if(!e)return s.status(404).json({message:"User not found"});const n=l().randomBytes(20).toString("hex"),a=Date.now()+36e5;e.resetPasswordToken=n,e.resetPasswordExpires=a,await e.save();const r=`http://localhost:5353/user/reset-password/${n}`,o=y().createTransport({host:"smtp.hostinger.com",port:465,secure:!0,auth:{user:"siteadmin@enego.co.in",pass:"Siteadmin@enego@321"}}),i={to:e.email,from:"siteadmin@enego.co.in",subject:"Password Reset Request",text:`You are receiving this email because you (or someone else) have requested to reset the password for your account.\n\n\n      Please click the following link, or paste it into your browser to complete the process:\n\n\n      ${r}\n\n\n      If you did not request this, please ignore this email and your password will remain unchanged.`};await o.sendMail(i),s.status(200).json({message:"Password reset link sent to your email."})}catch(e){s.status(500).json({message:"Server error."})}})),S.post("/reset-password/:token",(async(e,s)=>{const{token:t}=e.params,{newPassword:n}=e.body;try{const e=await u.findOne({resetPasswordToken:t,resetPasswordExpires:{$gt:Date.now()}});if(!e)return s.status(400).json({message:"Invalid or expired token"});const a=await h().genSalt(5),r=await h().hash(n,a);e.password=r,e.resetPasswordToken=void 0,e.resetPasswordExpires=void 0,await e.save(),s.status(200).json({message:"Password reset successfully"})}catch(e){s.status(500).json({message:"Server error"})}}));const k=S,q=t().Router();q.post("/addbooking",b,(async(e,s)=>{const{user_id:t,bdm:n,branch_name:a,company_name:r,contact_person:o,email:i,contact_no:d,services:u,total_amount:c,term_1:g,term_2:l,term_3:p,term_1_payment_date:y,term_2_payment_date:f,term_3_payment_date:h,closed_by:w,pan:v,gst:b,remark:_,date:S,status:k,bank:q,funddisbursement:N,state:A}=e.body,E={branch_name:a,contact_person:o,user_id:t,bdm:n,email:i,services:u,total_amount:c,pan:v,state:A,date:S},I=Object.entries(E).filter((([e,s])=>!s||"services"===e&&(!Array.isArray(s)||0===s.length))).map((([e])=>e));if(I.length>0)return s.status(400).send({message:`Missing required fields: ${I.join(", ")}`});try{const e={user_id:t,bdm:n,branch_name:a,company_name:r||"",contact_person:o,email:i,contact_no:d,closed_by:w,services:u,total_amount:c,term_1:g,term_2:l,term_3:p,term_1_payment_date:y,term_2_payment_date:f,term_3_payment_date:h,pan:v,gst:b||"N/A",remark:_,date:S||new Date,status:k,bank:q,state:A,after_disbursement:N},E=await m.create(e);return s.status(201).send({Message:"Booking Created Successfully",booking_id:E._id,booking:E})}catch(e){return console.log(e),s.status(500).send({message:e.message})}})),q.patch("/editbooking/:id",b,(async(e,s)=>{const{id:t}=e.params;let n=e.body;const a=e.headers["user-role"];if(!a)return s.status(400).send({message:"User role is required"});const{updatedBy:r,note:o}=n;delete n.updatedBy,delete n.note;try{const e=await m.findById(t);if(!e)return s.status(404).send("Booking not found");const i=["dev","senior admin"];if("admin"===a){const{services:e,...s}=n;n=s}const d={};for(let s in n){const t=e[s],a=n[s];Array.isArray(t)?JSON.stringify(t)!==JSON.stringify(a)&&(d[s]={old:t,new:a}):t!==a&&(d[s]={old:t,new:a})}if(0===Object.keys(d).length)return s.status(400).send({message:"No changes detected"});const u={updatedBy:r||"Unknown",updatedAt:new Date,note:o||"",changes:d};if(i.includes(a)||"admin"===a){const e=await m.findByIdAndUpdate(t,{$set:n,$push:{updatedhistory:u}},{new:!0});return s.status(200).send({message:"Booking Updated Successfully",updatedBooking:e})}return s.status(403).send({message:"You do not have permission to edit this booking"})}catch(e){return s.status(500).send({message:e.message})}})),q.delete("/deletebooking/:id",b,(async(e,s)=>{const{id:t}=e.params;try{if(!await m.findByIdAndDelete(t))return s.status(404).send("Booking not found");s.status(200).send({message:"Booking Deleted Successfully"})}catch(e){s.status(500).send(e)}})),q.get("/bookings",b,(async(e,s)=>{const{startDate:t,endDate:n}=e.query,a=e.query.userId,r=e.query.userRole;try{const e={};if(t&&n){const a=new Date(t),r=new Date(n);if(isNaN(a)||isNaN(r))return s.status(400).send({message:"Invalid date format"});r.setHours(23,59,59,999),e.date={$gte:a,$lte:r}}if(!r||!["dev","admin","senior admin"].includes(r)){if(!a)return s.status(403).send({message:"Access forbidden. No valid role or user ID provided."});e.user_id=a}const o=await m.find(e);if(0===o.length)return s.status(404).send({message:"No Bookings Found"});s.status(200).send(o)}catch(e){console.error("Error fetching bookings:",e.message),s.status(500).send({message:e.message})}})),q.get("/all",b,(async(e,s)=>{const t=e.query.limit,n=await m.find({}).sort({createdAt:-1}).limit(t);return 0!=n.length?s.status(200).send({message:"All Bookings Fetched Successfully",Allbookings:n}):s.status(404).send({message:"No Bookings To Show"})})),q.get("/bookings/status",(async(e,s)=>{const{status:t}=e.query,n=e.query.userId,a=e.query.userRole;try{if(!t||!["Pending","In Progress","Completed"].includes(t))return s.status(400).send({message:"Invalid or missing status parameter. Valid statuses are: Pending, In Progress, Completed."});let e;if(a&&["dev","admin","senior admin"].includes(a))e=await m.find({status:t});else{if(!n)return s.status(403).send({message:"Access forbidden. No valid role or user ID provided."});e=await m.find({user_id:n,status:t})}if(0===e.length)return s.status(404).send({message:"No Bookings Found for the given status"});s.status(200).send(e)}catch(e){console.error("Error fetching bookings by status:",e.message),s.status(500).send({message:e.message})}})),q.get("/bookings/services",b,(async(e,s)=>{const{service:t}=e.query,n=e.query.userId,a=e.query.userRole;try{if(!t)return s.status(400).send({message:"Missing service parameter."});if(!a||!["dev","admin","senior admin"].includes(a)){if(!n)return s.status(403).send({message:"Access forbidden. No valid role or user ID provided."});const e=await m.find({user_id:n,services:t});return 0===e.length?s.status(404).send({message:"No Bookings Found for the given user and service."}):s.status(200).send(e)}const e=await m.find({services:t});if(0===e.length)return s.status(404).send({message:"No Bookings Found for the given service."});s.status(200).send(e)}catch(e){console.error("Error fetching bookings by service:",e.message),s.status(500).send({message:e.message})}})),q.get("/bookings/filter",b,(async(e,s)=>{const{startDate:t,endDate:n,status:a,service:r,userId:o,userRole:i,bdmName:d}=e.query;try{const e={};if(t&&n){const a=new Date(t),r=new Date(n);if(isNaN(a)||isNaN(r))return s.status(400).send({message:"Invalid date format"});r.setHours(23,59,59,999),e.date={$gte:a,$lte:r}}if(a){if(!["Pending","In Progress","Completed"].includes(a))return s.status(400).send({message:"Invalid status value"});e.status=a}if(r&&(e.services=r),d&&(e.bdm={$regex:new RegExp(d,"i")}),!i||!["dev","admin","senior admin"].includes(i)){if(!o)return s.status(403).send({message:"Access forbidden. No valid role or user ID provided."});e.user_id=o}const u=await m.find(e).sort({createdAt:-1});if(!u.length)return s.status(404).send({message:"No Bookings Found"});s.status(200).send(u)}catch(e){console.error("Error in /bookings/filter:",e.message),s.status(500).send({message:e.message})}}));const N=q,A=a().Schema({name:{type:String,required:!0},value:{type:String,required:!0,unique:!0},status:{type:Boolean,required:!0}},{timestamps:!1,versionKey:!1}),E=a().model("service",A),I=t().Router();I.post("/api/services",b,(async(e,s)=>{const{name:t,value:n,status:a}=e.body;if(!t||!n||!a)return s.status(400).send("Invalid input data");const r={name:t,value:n,status:a};try{const e=await E.create(r);s.status(201).send({message:"Service added successfully",Service:e})}catch(e){s.status(500).send({message:"Error adding service",error:e.message})}})),I.patch("/api/services/:id",b,(async(e,s)=>{const{id:t}=e.params,n=e.body;if(!n||0===Object.keys(n).length)return s.status(400).send({message:"No fields provided for update"});try{const e=await E.findByIdAndUpdate(t,{$set:n},{new:!0,runValidators:!0});if(!e)return s.status(404).send({message:"Service not found"});s.status(200).send({message:"Service updated successfully",service:e})}catch(e){s.status(500).send({message:"Error updating service",error:e.message})}})),I.get("/api/services",b,(async(e,s)=>{try{const e=await E.find();if(!e||0===e.length)return s.status(404).send({message:"No services found"});s.status(200).send(e)}catch(e){console.error("Error fetching services:",e),s.status(500).send({message:"Error fetching services",error:e.message})}})),I.delete("/api/services/:id",b,(async(e,s)=>{const{id:t}=e.params;try{const e=await E.findByIdAndDelete(t);if(!e)return s.status(404).send({message:"Service not found"});s.status(200).send({message:"Service deleted successfully",service:e})}catch(e){s.status(500).send({message:"Error deleting service",error:e.message})}}));const P=I;o().config();const $=process.env.MAIL_USER,O=process.env.MAIL_PASS,x=t().Router();x.post("/api/welcome",(async(e,s)=>{const{email:t,name:n,amount:a}=e.body;try{const e=y().createTransport({host:"smtp.hostinger.com",port:465,secure:!0,auth:{user:`${$}`,pass:`${O}`}}),a={to:`${t}`,from:"no-reply@enego.co.in",subject:`Warm Welcome to ${n}  from ENEGO GROUP OF COMPANIES\n`,html:`\n        <p>Dear Sir/Madam,</p>\n\n        <p>\n          We are pleased to extend a warm welcome to <b>${n}</b> as a valued client of \n          <b>ENEGO GROUP OF COMPANIES</b>. We sincerely appreciate the trust you’ve placed in us and are \n          excited about the opportunity to collaborate and contribute to your success.\n        </p>\n\n        <p>\n          At <b>ENEGO GROUP OF COMPANIES</b>, we are dedicated to offering high-quality, tailored services \n          designed to meet the unique needs of <b>${n}</b>. Our experienced team is committed to providing \n          expert support and guidance at every stage of our partnership to ensure a smooth and successful experience.\n        </p>\n\n        <p>\n          To facilitate a seamless process, one of our dedicated representatives will be in touch shortly \n          to coordinate with you and gather any necessary information. Please don’t hesitate to reach out \n          with any questions, concerns, or special requests. Your satisfaction is our highest priority, and \n          we are here to support you every step of the way.\n        </p>\n\n        <p>\n          Thank you once again for choosing <b>ENEGO GROUP OF COMPANIES</b>. We look forward to a successful \n          and fruitful collaboration, and to helping <b>${n}</b> achieve its business objectives.\n        </p>\n\n        <p>\n          For any queries kindly mail us at <a href="mailto:support@enego.co.in">support@enego.co.in</a>\n        </p>\n\n        <p style="color: #555; font-size: 14px; margin-top: 20px;">\n          <i>This is a system-generated email. Please do not reply to this email.</i>\n        </p>\n\n        <p>Warm regards,</p>\n        <p><b>ENEGO GROUP OF COMPANIES</b></p>\n        <p><a href="https://enego.co.in">enego.co.in</a></p>\n      `};await e.sendMail(a),s.status(200).json({message:"Welcome Mail Sent Successfully."})}catch(e){s.status(500).json({message:"Server error.",error:e.message})}}));const B=x,D=require("cors");var U=e.n(D);const R=t()();R.use(t().json()),R.use(U()()),R.use(U()({origin:"*",methods:["GET","POST","PUT","DELETE","PATCH"],allowedHeaders:["Content-Type","Authorization","user-role"],credentials:!0})),R.use("/user",k),R.use("/booking",N),R.use("/services",P),R.use("/mail",B),R.get("/",((e,s)=>{s.send("<h1>server is running successfully</h1>")})),(async()=>{try{const e=await a().connect(process.env.Mongo_URL);console.log(`MongoDB Connected: ${e.connection.host}`)}catch(e){console.log({msg:"cannot connect to db",error:e.message}),process.exit(1)}})().then((()=>{console.log("connected"),R.listen(i,"0.0.0.0",(()=>{console.log(`Server is running at http://0.0.0.0:${i}`)}))})).catch((e=>{console.log(e)}))})();